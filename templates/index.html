<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多视频流推送系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .container {
            flex: 1;
        }
        .header {
            background-color: #343a40;
            color: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        .task-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .task-card .card-body {
            flex: 1;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-running {
            background-color: #28a745;
        }
        .status-stopped {
            background-color: #6c757d;
        }
        .status-error {
            background-color: #dc3545;
        }
        .btn {
            border-radius: 20px;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .footer {
            background-color: #343a40;
            color: white;
            padding: 1rem 0;
            margin-top: 2rem;
        }
        .modal-content {
            border-radius: 10px;
        }
        .modal-header {
            background-color: #007bff;
            color: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .spinner {
            display: none;
        }
        .table-hover tbody tr:hover {
            background-color: #f1f3f4;
        }
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background-color: transparent;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0"><i class="fas fa-video mr-2"></i>多视频流推送系统</h1>
                </div>
                <div class="col-md-6 text-right">
                    <button type="button" class="btn btn-success" id="createTaskBtn">
                        <i class="fas fa-plus mr-2"></i>创建任务
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="row" id="taskList">
            <!-- 任务列表会通过JavaScript动态加载 -->
            <div class="col-12 text-center py-5" id="emptyState">
                <div class="empty-icon mb-4"><i class="fas fa-film fa-4x text-gray-400"></i></div>
                <h3 class="text-gray-500 mb-2">暂无任务</h3>
                <p class="text-gray-400 mb-4">点击"创建任务"按钮开始使用</p>
                <button type="button" class="btn btn-primary" id="createFirstTaskBtn">
                    <i class="fas fa-plus mr-2"></i>创建第一个任务
                </button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">© 2024 多视频流推送系统</p>
        </div>
    </footer>

    <!-- 创建任务模态框 -->
    <div class="modal fade" id="createTaskModal" tabindex="-1" role="dialog" aria-labelledby="createTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createTaskModalLabel">创建新任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    </button>
                </div>
                <form id="createTaskForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="form-group mb-3">
                            <label for="taskName">任务名称</label>
                            <input type="text" class="form-control" id="taskName" name="task_name" placeholder="请输入唯一的任务名称">
                        </div>
                        <div class="form-group mb-3">
                            <label for="streamUrl">RTSP推流地址</label>
                            <input type="text" class="form-control" id="streamUrl" name="stream_url" placeholder="请输入RTSP推流地址">
                            <small class="form-text text-muted">例如: rtsp://localhost:8554/mystream</small>
                        </div>
                        <div class="form-group mb-3">
                            <label for="imageFile">图片</label>
                            <input type="file" class="form-control-file" id="imageFile" name="file" required>
                            <small class="form-text text-muted">请上传一张图片，系统将自动使用该图片的尺寸</small>
                            <div id="imageRatio" class="mt-2 text-sm text-success"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check mr-2"></i>创建
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // 初始化模态框
            const createTaskModal = new bootstrap.Modal(document.getElementById('createTaskModal'));
            
            // 按钮事件绑定
            $('#createTaskBtn, #createFirstTaskBtn').click(function() {
                createTaskModal.show();
            });
            
            // 图片文件选择事件，用于显示宽高比例
            $('#imageFile').change(function(e) {
                const file = e.target.files[0];
                if (file) {
                    const img = new Image();
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        img.src = event.target.result;
                        img.onload = function() {
                            const width = this.width;
                            const height = this.height;
                            
                            // 计算宽高比例并简化
                            const gcd = function(a, b) {
                                return b === 0 ? a : gcd(b, a % b);
                            };
                            const divisor = gcd(width, height);
                            const ratio = `${width/divisor}:${height/divisor}`;
                            
                            $('#imageRatio').text(`图片尺寸: ${width}x${height} (比例: ${ratio})`);
                        };
                    };
                    
                    reader.readAsDataURL(file);
                } else {
                    $('#imageRatio').text('');
                }
            });
            
            // 创建任务表单提交
            $('#createTaskForm').submit(function(e) {
                e.preventDefault();
                
                const taskName = $('#taskName').val().trim();
                const streamUrl = $('#streamUrl').val().trim();
                const imageFile = $('#imageFile')[0].files[0];
                
                if (!taskName || !streamUrl || !imageFile) {
                    alert('请填写所有必填字段');
                    return;
                }
                
                const formData = new FormData();
                formData.append('task_name', taskName);
                formData.append('stream_url', streamUrl);
                formData.append('file', imageFile);
                
                $.ajax({
                    url: '/api/task/create',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    beforeSend: function() {
                        $('#createTaskModal button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>创建中...');
                    },
                    success: function(response) {
                        if (response.success) {
                            createTaskModal.hide();
                            
                            // 显示自动关闭的成功提示
                            const successAlert = $(`<div class="alert alert-success fixed-top w-50 mx-auto mt-4 text-center fade-in" role="alert">
                                <i class="fas fa-check-circle mr-2"></i>
                                任务创建成功
                            </div>`);
                            
                            $('body').append(successAlert);
                            
                            // 5秒后自动关闭
                            setTimeout(() => {
                                successAlert.fadeOut(500, () => {
                                    successAlert.remove();
                                });
                            }, 5000);
                            
                            loadTasks();
                        } else {
                            alert('创建失败: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        // 尝试从响应中获取详细错误信息
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            alert('创建失败: ' + (errorData.message || '请检查网络连接'));
                        } catch {
                            alert('创建失败，请检查网络连接');
                        }
                    },
                    complete: function() {
                        $('#createTaskModal button[type="submit"]').prop('disabled', false).html('<i class="fas fa-check mr-2"></i>创建');
                        // 清空表单
                        $('#createTaskForm')[0].reset();
                    }
                });
            });
            
            // 加载任务列表
            function loadTasks() {
                $.ajax({
                    url: '/api/tasks',
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            const tasks = response.tasks;
                            const taskList = $('#taskList');
                            
                            taskList.empty();
                            
                            if (tasks.length === 0) {
                                $('#emptyState').show();
                            } else {
                                $('#emptyState').hide();
                                tasks.forEach(function(task) {
                                    const statusClass = task.status === 'running' ? 'status-running' : (task.status === 'error' ? 'status-error' : 'status-stopped');
                                    const statusText = task.status === 'running' ? '运行中' : (task.status === 'error' ? '错误' : '已停止');
                                    
                                    const card = $(`
                                        <div class="col-md-6 col-lg-4 mb-4">
                                            <div class="card task-card fade-in">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                                        <h5 class="card-title mb-0">${task.name}</h5>
                                                        <span class="status-indicator ${statusClass}"></span>
                                                    </div>
                                                    <p class="text-sm text-gray-500 mb-2">推流地址: ${task.stream_url}</p>
                                                    <p class="text-sm text-gray-500 mb-2">图片数量: ${task.image_list ? task.image_list.length : 0}张</p>
                                                    <p class="text-sm text-gray-500 mb-4">分辨率: ${task.width}x${task.height}</p>
                                                    <div class="d-flex justify-content-between">
                                                        <div>
                                                            <a href="/task/${task.task_id}" class="btn btn-primary btn-sm mr-2">
                                                                <i class="fas fa-info-circle mr-1"></i>详情
                                                            </a>
                                                            <button class="btn btn-danger btn-sm delete-task-btn" data-task-id="${task.task_id}">
                                                                <i class="fas fa-trash-alt mr-1"></i>删除
                                                            </button>
                                                        </div>
                                                        <div>
                                                            ${task.status !== 'running' ? `
                                                                <button class="btn btn-success btn-sm start-task-btn" data-task-id="${task.task_id}">
                                                                    <i class="fas fa-play mr-1"></i>启动
                                                                </button>
                                                            ` : `
                                                                <button class="btn btn-danger btn-sm stop-task-btn" data-task-id="${task.task_id}">
                                                                    <i class="fas fa-stop mr-1"></i>停止
                                                                </button>
                                                            `}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `);
                                    
                                    taskList.append(card);
                                });
                                
                                // 绑定启动/停止/删除按钮事件
                                $('.start-task-btn').click(function() {
                                    const taskId = $(this).data('task-id');
                                    startTask(taskId);
                                });
                                
                                $('.stop-task-btn').click(function() {
                                    const taskId = $(this).data('task-id');
                                    stopTask(taskId);
                                });
                                
                                $('.delete-task-btn').click(function() {
                                    const taskId = $(this).data('task-id');
                                    deleteTask(taskId);
                                });
                            }
                        }
                    },
                    error: function() {
                        console.error('加载任务列表失败');
                    }
                });
            }
            
            // 启动任务
            function startTask(taskId) {
                $.ajax({
                    url: `/api/task/${taskId}/start`,
                    type: 'POST',
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            alert('推流已启动');
                            loadTasks();
                        } else {
                            alert('启动失败: ' + response.message);
                        }
                    },
                    error: function() {
                        alert('启动失败，请检查网络连接');
                    }
                });
            }
            
            // 停止任务
            function stopTask(taskId) {
                $.ajax({
                    url: `/api/task/${taskId}/stop`,
                    type: 'POST',
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            alert('推流已停止');
                            loadTasks();
                        } else {
                            alert('停止失败: ' + response.message);
                        }
                    },
                    error: function() {
                        alert('停止失败，请检查网络连接');
                    }
                });
            }
            
            // 删除任务
            function deleteTask(taskId) {
                if (confirm('确定要删除此任务吗？此操作不可撤销。')) {
                    $.ajax({
                        url: `/api/task/${taskId}/delete`,
                        type: 'POST',
                        dataType: 'json',
                        success: function(response) {
                            if (response.success) {
                                alert('任务删除成功');
                                loadTasks();
                            } else {
                                alert('删除失败: ' + response.message);
                            }
                        },
                        error: function() {
                            alert('删除失败，请检查网络连接');
                        }
                    });
                }
            }
            
            // 页面加载时加载任务列表
            loadTasks();
            
            // 定期刷新任务列表
            setInterval(loadTasks, 5000); // 每5秒刷新一次
        });
    </script>
</body>
</html>